<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire Maraba Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .login-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .duplicate-phone {
            color: #dc2626 !important;
            font-weight: bold;
        }
        
        #tableContainer {
            max-height: calc(100vh - 250px);
            overflow: auto;
            position: relative;
        }
        
        #commandsTable thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }
        
        #commandsTable td:nth-child(1),
        #commandsTable td:nth-child(2),
        #commandsTable th:nth-child(1),
        #commandsTable th:nth-child(2) {
            position: sticky;
            background: white;
            z-index: 5;
        }
        
        #commandsTable td:nth-child(1),
        #commandsTable th:nth-child(1) {
            left: 0;
        }
        
        #commandsTable td:nth-child(2),
        #commandsTable th:nth-child(2) {
            left: 50px;
        }
        
        .tab-btn {
            transition: all 0.3s ease;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        select, input, textarea {
            font-size: 0.75rem;
        }
        
        .select-closing, .select-livreur {
            min-width: 120px;
        }
        
        .comment-input {
            min-height: 35px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- √âcran de connexion -->
    <div id="loginScreen" class="login-bg flex items-center justify-center">
        <div class="glass-card p-8 w-96">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 animate-bounce">üì¶</div>
                <h1 class="text-3xl font-bold text-gray-800">Gestionnaire Maraba Shop</h1>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" placeholder="Entrez votre identifiant">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()" class="w-full btn-gradient text-white py-3 rounded-lg font-semibold">
                    Se connecter
                </button>
                <div id="loginError" class="text-red-500 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Application principale -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-20">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-800">üì¶ Gestionnaire Maraba Shop</h1>
                    <span id="userRole" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="syncGoogleSheets()" class="btn-gradient text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <span>üîÑ</span>
                        <span>Synchroniser</span>
                    </button>
                    <button onclick="exportJSON()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        üì• Exporter
                    </button>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b sticky top-16 z-10">
            <div class="container mx-auto px-4">
                <div class="flex space-x-2">
                    <button onclick="showTab('dashboard')" class="tab-btn tab-active px-6 py-3 font-semibold rounded-t-lg" data-tab="dashboard">üìä Dashboard</button>
                    <button onclick="showTab('commandes')" class="tab-btn px-6 py-3 font-semibold rounded-t-lg hover:bg-gray-100" data-tab="commandes">üì¶ Commandes</button>
                    <button onclick="showTab('depenses')" id="depensesTab" class="tab-btn px-6 py-3 font-semibold rounded-t-lg hover:bg-gray-100" data-tab="depenses">üí∞ D√©penses</button>
                    <button onclick="showTab('equipe')" class="tab-btn px-6 py-3 font-semibold rounded-t-lg hover:bg-gray-100" data-tab="equipe">üë• √âquipe</button>
                    <button onclick="showTab('configuration')" id="configTab" class="tab-btn px-6 py-3 font-semibold rounded-t-lg hover:bg-gray-100" data-tab="configuration">‚öôÔ∏è Configuration</button>
                </div>
            </div>
        </nav>

        <!-- Contenu -->
        <div class="container mx-auto px-4 py-6">
            
            <!-- Tab Dashboard -->
            <div id="tabDashboard" class="tab-content">
                <!-- Filtres de dates -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date d√©but</label>
                            <input type="date" id="filterDateDebut" onchange="updateDashboard()" class="border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date fin</label>
                            <input type="date" id="filterDateFin" onchange="updateDashboard()" class="border rounded px-3 py-2">
                        </div>
                        <button onclick="resetDateFilters()" class="mt-6 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            R√©initialiser
                        </button>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="stat-card bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">CA Total</p>
                                <p id="caTotal" class="text-3xl font-bold text-blue-600">0 F</p>
                            </div>
                            <div class="text-4xl">üí∞</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">D√©penses</p>
                                <p id="depensesTotal" class="text-3xl font-bold text-red-600">0 F</p>
                            </div>
                            <div class="text-4xl">üìâ</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">B√©n√©fice</p>
                                <p id="beneficeTotal" class="text-3xl font-bold text-green-600">0 F</p>
                            </div>
                            <div class="text-4xl">üìà</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Commandes</p>
                                <p id="totalCommandes" class="text-3xl font-bold text-purple-600">0</p>
                            </div>
                            <div class="text-4xl">üì¶</div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">CA par mois</h3>
                        <canvas id="caChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Top 5 D√©penses</h3>
                        <canvas id="depensesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab Commandes -->
            <div id="tabCommandes" class="tab-content hidden">
                <!-- Filtres -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="searchFilter" placeholder="üîç Rechercher..." class="border rounded px-3 py-2" onkeyup="filterCommands()">
                        <select id="statusFilter" class="border rounded px-3 py-2" onchange="filterCommands()">
                            <option value="">Tous les statuts</option>
                        </select>
                        <select id="closingFilter" class="border rounded px-3 py-2" onchange="filterCommands()">
                            <option value="">Tous (Closing)</option>
                        </select>
                        <div class="flex space-x-2">
                            <input type="date" id="dateFilter" class="border rounded px-3 py-2 flex-1" onchange="filterCommands()">
                            <input type="date" id="dateFilterEnd" class="border rounded px-3 py-2 flex-1" onchange="filterCommands()">
                        </div>
                    </div>
                </div>

                <!-- Tableau -->
                <div class="bg-white rounded-lg shadow">
                    <div id="tableContainer">
                        <table id="commandsTable" class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">#</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">ID</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Date</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Produit</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Nom</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Email</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">T√©l√©phone</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Ville</th>
                                    <th class="px-10 py-3 text-left text-xs font-semibold text-gray-700">Statut</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Closing</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Livreur</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Montant</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Com1</th>
                                    <th class="px-2 py-3 text-left text-xs font-semibold text-gray-700">Com2</th>
                                </tr>
                            </thead>
                            <tbody id="commandsTableBody">
                                <!-- Donn√©es charg√©es dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab D√©penses -->
            <div id="tabDepenses" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Gestion des d√©penses</h2>
                        <button onclick="ajouterDepense()" class="btn-gradient text-white px-4 py-2 rounded-lg">
                            ‚ûï Ajouter une d√©pense
                        </button>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left">Date</th>
                                <th class="px-4 py-3 text-left">Cat√©gorie</th>
                                <th class="px-4 py-3 text-left">Description</th>
                                <th class="px-4 py-3 text-right">Montant</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="depensesTableBody">
                            <!-- Donn√©es charg√©es dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab √âquipe -->
            <div id="tabEquipe" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow" id="julianaStats"></div>
                    <div class="bg-white p-6 rounded-lg shadow" id="patriciaStats"></div>
                </div>
            </div>

            <!-- Tab Configuration -->
            <div id="tabConfiguration" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- √âquipe -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">√âquipe Closing</h3>
                        <div id="collaborators-list" class="space-y-2 mb-4"></div>
                        <button onclick="ajouterCollaborateur()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            ‚ûï Ajouter une personne
                        </button>
                    </div>

                    <!-- Livreurs -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Services de livraison</h3>
                        <div id="delivery-services-list" class="space-y-2 mb-4"></div>
                        <button onclick="ajouterLivreur()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            ‚ûï Ajouter un service
                        </button>
                    </div>

                    <!-- Couleurs des statuts -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Couleurs des statuts</h3>
                        <div id="status-colors-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // √âtat global de l'application
        let appState = {
            currentUser: null,
            userRole: null,
            commands: [],
            depenses: [],
            collaborators: ['Juliana', 'Patricia'],
            deliveryServices: ['Marius', 'Mansa livraison', 'VCA livraison', '192 Express', 'Go livraison'],
            statuts: ['Nouveau', 'Confirm√©', 'En attente de d√©p√¥t', 'D√©p√¥t OK', 'Livr√©', 'Report√©', 'Passe pas', 'Ne d√©croche pas', 'Non livr√© (retour livreur)', 'Annul√©', 'Doublon', 'Retourn√© (non satisfait)'],
            statusColors: {
                'Livr√©': '#d1fae5',
                'Confirm√©': '#dbeafe',
                'Annul√©': '#f3f4f6',
                'D√©p√¥t OK': '#fef3c7'
            }
        };

        // Utilisateurs et mots de passe
        const users = {
            'admin': { password: 'admindea', role: 'admin', name: 'Administrateur' },
            'juliana': { password: 'Juliana100', role: 'closing', name: 'Juliana' },
            'patricia': { password: 'Patricia10', role: 'closing', name: 'Patricia' }
        };

        // Connexion
        function login() {
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (users[username] && users[username].password === password) {
                appState.currentUser = users[username].name;
                appState.userRole = users[username].role;
                
                localStorage.setItem('loggedUser', JSON.stringify({
                    user: appState.currentUser,
                    role: appState.userRole
                }));

                showMainApp();
            } else {
                errorDiv.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                errorDiv.classList.remove('hidden');
            }
        }

        // V√©rifier session au chargement
        window.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('loggedUser');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                appState.currentUser = session.user;
                appState.userRole = session.role;
                showMainApp();
            }
        });

        // Afficher l'application principale
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userRole').textContent = appState.currentUser;

            // Masquer les onglets selon le r√¥le
            if (appState.userRole !== 'admin') {
                document.getElementById('configTab').classList.add('hidden');
                document.getElementById('depensesTab').classList.add('hidden');
            }

            loadData();
            updateDashboard();
            updateCommandsTable();
            updateDepensesTable();
            updateConfigUI();
        }

        // D√©connexion
        function logout() {
            localStorage.removeItem('loggedUser');
            location.reload();
        }

        // Gestion des onglets
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'equipe') updateEquipeStats();
        }

        // Synchroniser avec Google Sheets
        async function syncGoogleSheets() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbzsS-ZVZw1135BRIDgO1p0DYM_l_AUal9fULfPJq4XzMNNq6fTSvnaoX27Y0kHiH5G_FA/exec');
                const data = await response.json();

                let newCount = 0;
                data.forEach(row => {
                    const existing = appState.commands.find(cmd => cmd.sheetRow === row.sheetRow);
                    
                    if (!existing) {
                        // Nouvelle commande
                        appState.commands.push({
                            sheetRow: row.sheetRow,
                            id: row['Order ID'] || '',
                            date: row['Order date'] || '',
                            produit: row['Product name'] || '',
                            nom: row['Nom et Prenom'] || '',
                            email: row['Email'] || '',
                            telephone: row['Phone'] || '',
                            ville: row['City'] || '',
                            statut: row['Statut'] || 'Nouveau',
                            closing: row['Closing'] || '',
                            livreur: row['Livreur'] || '',
                            montant: parseFloat(row['Montant']) || 0,
                            com1: row['Com1'] || '',
                            com2: row['Com2'] || '',
                            lienWha: `https://wa.me/+225${row['Phone']}`,
                            dateModif: new Date().toISOString()
                        });
                        newCount++;
                    } else {
                        // Commande existante : mettre √† jour depuis Google Sheets
                        existing.id = row['Order ID'] || existing.id;
                        existing.date = row['Order date'] || existing.date;
                        existing.produit = row['Product name'] || existing.produit;
                        existing.nom = row['Nom et Prenom'] || existing.nom;
                        existing.email = row['Email'] || existing.email;
                        existing.telephone = row['Phone'] || existing.telephone;
                        existing.ville = row['City'] || existing.ville;
                        existing.statut = row['Statut'] || existing.statut;
                        existing.closing = row['Closing'] || existing.closing;
                        existing.livreur = row['Livreur'] || existing.livreur;
                        existing.montant = parseFloat(row['Montant']) || existing.montant;
                        existing.com1 = row['Com1'] || existing.com1;
                        existing.com2 = row['Com2'] || existing.com2;
                        existing.lienWha = `https://wa.me/+225${row['Phone']}`;
                    }
                });

                saveData();
                updateCommandsTable();
                updateDashboard();

                if (appState.userRole === 'admin') {
                    alert(`‚úÖ Synchronisation r√©ussie!\n${newCount} nouvelle(s) commande(s) import√©e(s)\nTotal: ${appState.commands.length} commandes`);
                } else {
                    alert('‚úÖ Vos commandes sont √† jour');
                }
            } catch (error) {
                alert('‚ùå Erreur de synchronisation: ' + error.message);
            }
        }

        // Sauvegarder les donn√©es
        function saveData() {
            localStorage.setItem('commands', JSON.stringify(appState.commands));
            localStorage.setItem('depenses', JSON.stringify(appState.depenses));
            localStorage.setItem('collaborators', JSON.stringify(appState.collaborators));
            localStorage.setItem('deliveryServices', JSON.stringify(appState.deliveryServices));
            localStorage.setItem('statusColors', JSON.stringify(appState.statusColors));
        }

        // Charger les donn√©es
        function loadData() {
            const savedCommands = localStorage.getItem('commands');
            const savedDepenses = localStorage.getItem('depenses');
            const savedCollaborators = localStorage.getItem('collaborators');
            const savedDeliveryServices = localStorage.getItem('deliveryServices');
            const savedStatusColors = localStorage.getItem('statusColors');

            if (savedCommands) appState.commands = JSON.parse(savedCommands);
            if (savedDepenses) appState.depenses = JSON.parse(savedDepenses);
            if (savedCollaborators) appState.collaborators = JSON.parse(savedCollaborators);
            if (savedDeliveryServices) appState.deliveryServices = JSON.parse(savedDeliveryServices);
            if (savedStatusColors) appState.statusColors = JSON.parse(savedStatusColors);
        }

        // Filtrer les commandes selon le r√¥le
        function getFilteredCommands() {
            let filtered = [...appState.commands];

            if (appState.userRole === 'closing') {
                if (appState.currentUser === 'Juliana') {
                    filtered = filtered.filter(cmd => 
                        cmd.closing === 'Juliana' || cmd.closing === ''
                    );
                } else if (appState.currentUser === 'Patricia') {
                    filtered = filtered.filter(cmd => cmd.closing === 'Patricia');
                }
            }

            return filtered;
        }

        // Mettre √† jour le tableau des commandes
        function updateCommandsTable() {
            const tbody = document.getElementById('commandsTableBody');
            const filtered = getFilteredCommands();
            
            // D√©tecter les doublons
            const phoneCount = {};
            filtered.forEach(cmd => {
                phoneCount[cmd.telephone] = (phoneCount[cmd.telephone] || 0) + 1;
            });

            tbody.innerHTML = filtered.map(cmd => {
                const isDuplicate = phoneCount[cmd.telephone] > 1;
                const bgColor = appState.statusColors[cmd.statut] || '#ffffff';
                const canEditMontant = appState.userRole === 'admin';

                return `
                    <tr style="background-color: ${bgColor}">
                        <td class="px-2 py-2 text-xs">${cmd.sheetRow}</td>
                        <td class="px-2 py-2 text-xs">${cmd.id}</td>
                        <td class="px-2 py-2 text-xs">${cmd.date}</td>
                        <td class="px-2 py-2 text-xs">${cmd.produit.substring(0, 30)}...</td>
                        <td class="px-2 py-2 text-xs">${cmd.nom}</td>
                        <td class="px-2 py-2 text-xs">${cmd.email}</td>
                        <td class="px-2 py-2 text-xs">
                            <a href="${cmd.lienWha}" target="_blank" class="${isDuplicate ? 'duplicate-phone' : 'text-green-600'}">
                                ${cmd.telephone}
                                ${isDuplicate ? '<span class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded">DOUBLON</span>' : ''}
                            </a>
                        </td>
                        <td class="px-2 py-2 text-xs">${cmd.ville}</td>
                        <td class="px-10 py-3">
                            <select onchange="updateCommand(${cmd.sheetRow}, 'statut', this.value)" class="border rounded px-10 py-3 text-sm w-full">
                                ${appState.statuts.map(s => `<option value="${s}" ${cmd.statut === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-2 py-2">
                            <select onchange="updateCommand(${cmd.sheetRow}, 'closing', this.value)" class="border rounded px-1 py-1 text-xs select-closing" ${appState.userRole === 'closing' && appState.currentUser === 'Patricia' ? 'disabled' : ''}>
                                <option value="">Non assign√©</option>
                                ${appState.collaborators.map(c => `<option value="${c}" ${cmd.closing === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-2 py-2">
                            <select onchange="updateCommand(${cmd.sheetRow}, 'livreur', this.value)" class="border rounded px-1 py-1 text-xs select-livreur">
                                <option value="">Non assign√©</option>
                                ${appState.deliveryServices.map(l => `<option value="${l}" ${cmd.livreur === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-2 py-2">
                            <input type="number" value="${cmd.montant}" onchange="updateCommand(${cmd.sheetRow}, 'montant', this.value)" class="border rounded px-2 py-1 text-xs w-24" ${!canEditMontant ? 'readonly' : ''}>
                        </td>
                        <td class="px-2 py-2">
                            <textarea onchange="updateCommand(${cmd.sheetRow}, 'com1', this.value)" class="border rounded px-2 py-1 text-xs comment-input w-full" rows="2">${cmd.com1}</textarea>
                        </td>
                        <td class="px-2 py-2">
                            <textarea onchange="updateCommand(${cmd.sheetRow}, 'com2', this.value)" class="border rounded px-2 py-1 text-xs comment-input w-full" rows="2">${cmd.com2}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mettre √† jour les filtres
            updateFilters();
        }

        // Mettre √† jour une commande
        async function updateCommand(sheetRow, field, value) {
            const cmd = appState.commands.find(c => c.sheetRow === sheetRow);
            if (cmd) {
                cmd[field] = value;
                cmd.dateModif = new Date().toISOString();

                // Auto-remplir le montant si livr√© ou d√©p√¥t OK
                if (field === 'statut' && (value === 'Livr√©' || value === 'D√©p√¥t OK')) {
                    if (cmd.montant === 0) {
                        cmd.montant = 10000;
                    }
                }

                saveData();
                
                // Envoyer la modification vers Google Sheets
                try {
                    await fetch('https://script.google.com/macros/s/AKfycbzsS-ZVZw1135BRIDgO1p0DYM_l_AUal9fULfPJq4XzMNNq6fTSvnaoX27Y0kHiH5G_FA/exec', {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cmd)
                    });
                } catch (error) {
                    console.error('Erreur sauvegarde Google Sheets:', error);
                }
                
                updateCommandsTable();
                updateDashboard();
            }
        }

        // Mettre √† jour les filtres
        function updateFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const closingFilter = document.getElementById('closingFilter');

            statusFilter.innerHTML = '<option value="">Tous les statuts</option>' + 
                appState.statuts.map(s => `<option value="${s}">${s}</option>`).join('');

            closingFilter.innerHTML = '<option value="">Tous (Closing)</option>' + 
                appState.collaborators.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Filtrer les commandes
        function filterCommands() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const closing = document.getElementById('closingFilter').value;
            const dateStart = document.getElementById('dateFilter').value;
            const dateEnd = document.getElementById('dateFilterEnd').value;

            const tbody = document.getElementById('commandsTableBody');
            const rows = tbody.getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0) return;

                const text = row.textContent.toLowerCase();
                const cmdDate = cells[2].textContent;
                const cmdStatus = cells[8].querySelector('select').value;
                const cmdClosing = cells[9].querySelector('select').value;

                let show = true;

                if (search && !text.includes(search)) show = false;
                if (status && cmdStatus !== status) show = false;
                if (closing && cmdClosing !== closing) show = false;
                if (dateStart && cmdDate < dateStart) show = false;
                if (dateEnd && cmdDate > dateEnd) show = false;

                row.style.display = show ? '' : 'none';
            });
        }

        // Mettre √† jour le dashboard
        function updateDashboard() {
            const dateDebut = document.getElementById('filterDateDebut').value;
            const dateFin = document.getElementById('filterDateFin').value;

            let filtered = getFilteredCommands();

            if (dateDebut) {
                filtered = filtered.filter(cmd => cmd.date >= dateDebut);
            }
            if (dateFin) {
                filtered = filtered.filter(cmd => cmd.date <= dateFin);
            }

            // Calculer le CA
            const ca = filtered.reduce((sum, cmd) => sum + (parseFloat(cmd.montant) || 0), 0);
            
            // Calculer les d√©penses
            let depensesFiltered = appState.depenses;
            if (dateDebut || dateFin) {
                depensesFiltered = depensesFiltered.filter(dep => {
                    if (dateDebut && dep.date < dateDebut) return false;
                    if (dateFin && dep.date > dateFin) return false;
                    return true;
                });
            }
            const totalDepenses = depensesFiltered.reduce((sum, dep) => sum + parseFloat(dep.montant), 0);
            
            // Calculer le b√©n√©fice
            const benefice = ca - totalDepenses;

            // Mettre √† jour les KPIs
            document.getElementById('caTotal').textContent = ca.toLocaleString() + ' F';
            document.getElementById('depensesTotal').textContent = totalDepenses.toLocaleString() + ' F';
            document.getElementById('beneficeTotal').textContent = benefice.toLocaleString() + ' F';
            document.getElementById('totalCommandes').textContent = filtered.length;

            // Mettre √† jour les graphiques
            updateCAChart(filtered);
            updateDepensesChart(depensesFiltered);
        }

        // Graphique CA par mois
        let caChartInstance = null;
        function updateCAChart(commands) {
            const ctx = document.getElementById('caChart');
            
            // Grouper par mois
            const caParMois = {};
            commands.forEach(cmd => {
                if (cmd.montant > 0 && cmd.date) {
                    const mois = cmd.date.substring(0, 7); // YYYY-MM
                    caParMois[mois] = (caParMois[mois] || 0) + parseFloat(cmd.montant);
                }
            });

            const labels = Object.keys(caParMois).sort();
            const data = labels.map(m => caParMois[m]);

            if (caChartInstance) caChartInstance.destroy();

            caChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CA (F)',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Graphique top d√©penses
        let depensesChartInstance = null;
        function updateDepensesChart(depenses) {
            const ctx = document.getElementById('depensesChart');
            
            // Grouper par cat√©gorie
            const parCategorie = {};
            depenses.forEach(dep => {
                parCategorie[dep.categorie] = (parCategorie[dep.categorie] || 0) + parseFloat(dep.montant);
            });

            // Trier et prendre le top 5
            const sorted = Object.entries(parCategorie).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const labels = sorted.map(s => s[0]);
            const data = sorted.map(s => s[1]);

            if (depensesChartInstance) depensesChartInstance.destroy();

            depensesChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // R√©initialiser les filtres de dates
        function resetDateFilters() {
            document.getElementById('filterDateDebut').value = '';
            document.getElementById('filterDateFin').value = '';
            updateDashboard();
        }

        // Ajouter une d√©pense
        function ajouterDepense() {
            const date = prompt('Date (YYYY-MM-DD):');
            const categorie = prompt('Cat√©gorie (Facebook Ads, Livraison, Fournisseur, etc.):');
            const description = prompt('Description:');
            const montant = prompt('Montant (F):');

            if (date && categorie && montant) {
                appState.depenses.push({
                    id: Date.now(),
                    date,
                    categorie,
                    description: description || '',
                    montant: parseFloat(montant)
                });
                saveData();
                updateDepensesTable();
                updateDashboard();
            }
        }

        // Mettre √† jour le tableau des d√©penses
        function updateDepensesTable() {
            const tbody = document.getElementById('depensesTableBody');
            tbody.innerHTML = appState.depenses.map(dep => `
                <tr>
                    <td class="px-4 py-3">${dep.date}</td>
                    <td class="px-4 py-3">${dep.categorie}</td>
                    <td class="px-4 py-3">${dep.description}</td>
                    <td class="px-4 py-3 text-right font-semibold">${dep.montant.toLocaleString()} F</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="supprimerDepense(${dep.id})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Supprimer une d√©pense
        function supprimerDepense(id) {
            if (confirm('Supprimer cette d√©pense ?')) {
                appState.depenses = appState.depenses.filter(d => d.id !== id);
                saveData();
                updateDepensesTable();
                updateDashboard();
            }
        }

        // Mettre √† jour les stats de l'√©quipe
        function updateEquipeStats() {
            ['Juliana', 'Patricia'].forEach(name => {
                const commands = appState.commands.filter(c => c.closing === name);
                const livrees = commands.filter(c => c.statut === 'Livr√©').length;
                const confirmees = commands.filter(c => c.statut === 'Confirm√©' || c.statut === 'D√©p√¥t OK').length;
                const ca = commands.reduce((sum, c) => sum + (parseFloat(c.montant) || 0), 0);
                
                const tauxConfirmation = commands.length > 0 ? ((confirmees / commands.length) * 100).toFixed(1) : 0;
                const tauxLivraison = confirmees > 0 ? ((livrees / confirmees) * 100).toFixed(1) : 0;

                const container = document.getElementById(name.toLowerCase() + 'Stats');
                container.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">${name}</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-gray-600">Commandes trait√©es</p>
                            <p class="text-2xl font-bold">${commands.length}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Taux de confirmation</p>
                            <p class="text-2xl font-bold text-blue-600">${tauxConfirmation}%</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Taux de livraison</p>
                            <p class="text-2xl font-bold text-green-600">${tauxLivraison}%</p>
                        </div>
                        <div>
                            <p class="text-gray-600">CA g√©n√©r√©</p>
                            <p class="text-2xl font-bold text-purple-600">${ca.toLocaleString()} F</p>
                        </div>
                    </div>
                `;
            });
        }

        // Ajouter un collaborateur
        function ajouterCollaborateur() {
            const nom = prompt('Nom du nouveau membre:');
            if (nom && !appState.collaborators.includes(nom)) {
                appState.collaborators.push(nom);
                saveData();
                updateConfigUI();
                updateCommandsTable();
            }
        }

        // Supprimer un collaborateur
        function supprimerCollaborateur(nom) {
            if (confirm(`Supprimer ${nom} ?`)) {
                appState.collaborators = appState.collaborators.filter(c => c !== nom);
                saveData();
                updateConfigUI();
                updateCommandsTable();
            }
        }

        // Ajouter un livreur
        function ajouterLivreur() {
            const nom = prompt('Nom du nouveau service de livraison:');
            if (nom && !appState.deliveryServices.includes(nom)) {
                appState.deliveryServices.push(nom);
                saveData();
                updateConfigUI();
                updateCommandsTable();
            }
        }

        // Supprimer un livreur
        function supprimerLivreur(nom) {
            if (confirm(`Supprimer ${nom} ?`)) {
                appState.deliveryServices = appState.deliveryServices.filter(l => l !== nom);
                saveData();
                updateConfigUI();
                updateCommandsTable();
            }
        }

        // Mettre √† jour l'interface de configuration
        function updateConfigUI() {
            // Liste des collaborateurs
            const collabList = document.getElementById('collaborators-list');
            collabList.innerHTML = appState.collaborators.map(c => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded">
                    <span>${c}</span>
                    <button onclick="supprimerCollaborateur('${c}')" class="text-red-500 hover:text-red-700">üóëÔ∏è Supprimer</button>
                </div>
            `).join('');

            // Liste des livreurs
            const deliveryList = document.getElementById('delivery-services-list');
            deliveryList.innerHTML = appState.deliveryServices.map(l => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded">
                    <span>${l}</span>
                    <button onclick="supprimerLivreur('${l}')" class="text-red-500 hover:text-red-700">üóëÔ∏è Supprimer</button>
                </div>
            `).join('');

            // Couleurs des statuts
            const statusList = document.getElementById('status-colors-list');
            statusList.innerHTML = appState.statuts.map(s => `
                <div class="flex items-center space-x-4">
                    <span class="w-40">${s}</span>
                    <input type="text" value="${appState.statusColors[s] || '#ffffff'}" 
                        onchange="updateStatusColor('${s}', this.value)"
                        class="border rounded px-3 py-2 w-32" placeholder="#RRGGBB">
                    <input type="color" value="${appState.statusColors[s] || '#ffffff'}"
                        onchange="updateStatusColor('${s}', this.value)"
                        class="w-12 h-10 rounded cursor-pointer">
                </div>
            `).join('');
        }

        // Mettre √† jour la couleur d'un statut
        function updateStatusColor(statut, couleur) {
            if (/^#[0-9A-F]{6}$/i.test(couleur)) {
                appState.statusColors[statut] = couleur;
                saveData();
                updateCommandsTable();
                updateConfigUI();
            }
        }

        // Exporter en JSON
        function exportJSON() {
            const dataStr = JSON.stringify(appState.commands, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `commandes_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // G√©rer Enter sur les champs de connexion
        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login();
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login();
                });
            }
        });
    </script>
</body>
</html>





